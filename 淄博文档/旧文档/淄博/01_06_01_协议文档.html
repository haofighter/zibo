<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5598"/>

<div>
<span><div><div><div><br/></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 596px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div><span style="font-size: 18pt;">修改日期</span></div></td><td style="width: 596px; padding: 8px; border: 1px solid;"><div><span style="font-size: 18pt;">修改内容</span></div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2019/8/26</div></td><td style="width: 596px; padding: 8px; border: 1px solid;"><div>1.寻卡数据返回，块7.8.9错，改为块8.9.A</div><div>2.消费返回添加说明</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2019/8/30</div></td><td style="width: 596px; padding: 8px; border: 1px solid;"><div>根据&lt;多票制分段计价收费方案20190829.pdf&gt;修改多票消费文件结构数据，并添加M1卡的子卡类型</div></td></tr></tbody></table><div><br/></div></div><div><span style="font-size: 18pt;">1.PSAM卡复位命令</span></div><div><span style="font-size: 14pt;">下发命令：</span></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 474px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>定义</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>数据（16进制）</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>长度(字节)</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令头</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>02</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>设备类型</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>85</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令编码</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>3e</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令参数</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令长度</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>校验</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>afd0476d</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>4</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>结束字</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>03</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr></tbody></table><div><span style="font-size: 14pt;">消费返回：</span></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 256px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>定义</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>数据（16进制）</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>长度(字节)</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令头</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>02</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>设备类型</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>05</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令编码</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>3e</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令参数</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>状态</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令长度</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>0024</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>接收参数结构体</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>如下</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>36</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>校验</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>************</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>4</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>结束字</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>03</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr></tbody></table><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">//卡槽J7的卡，对应于M1的密钥</span></div><div>    uint8_t slot;//选择卡槽</div><div>    uint8_t PosID[6];//终端号</div><div>    uint8_t serialNum[10];//PSAM卡号</div><div>    uint8_t key_index;    //密钥索引</div><div>//卡槽J8的卡，对应于CPU的密钥</div><div>   uint8_t slot;//选择卡槽</div><div>    uint8_t PosID[6];//终端号</div><div>    uint8_t serialNum[10];//PSAM卡号</div><div>    uint8_t key_index;    //密钥索引</div></div><hr/><div><span style="font-size: 18pt;">1.M1</span></div><div><span style="font-size: 18pt;"><img src="01_06_01_协议文档_files/Image.png" type="image/png" data-filename="Image.png"/></span></div><div>更多资料请查看</div><div><a href="01_06_01_协议文档_files/淄博公交卡片结构及流程_改造后(修正)(1)(1).pdf"><img src="01_06_01_协议文档_files/bcdfdc9ac2a4411d823fa69b799c13bf.png" alt="淄博公交卡片结构及流程_改造后(修正)(1)(1).pdf"></a></div><div><a href="01_06_01_协议文档_files/淄博CPU卡规划20180321.pdf"><img src="01_06_01_协议文档_files/72aaa0e251e5caf3adfb1f5e7ed787a8.png" alt="淄博CPU卡规划20180321.pdf"></a></div><div><a href="01_06_01_协议文档_files/多票制分段计价收费方案(1).docx"><img src="01_06_01_协议文档_files/22d0d0fe73a631ceae8b1bfe6497613f.png" alt="多票制分段计价收费方案(1).docx"></a></div><div><a href="01_06_01_协议文档_files/多票制分段计价收费方案20190829.pdf"><img src="01_06_01_协议文档_files/b2a900d455d9d6a0954c1c1b69ba9230.png" alt="多票制分段计价收费方案20190829.pdf"></a></div><div><br/></div><div><span style="font-size: 14pt;">1.1 寻卡数据返回</span></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>定义</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>数据（16进制）</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>长度(字节)</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令头</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>02</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>设备类型</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>86</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令编码</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>40</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令参数</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>状态</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令长度</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>0122</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>接收参数结构体</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>如下</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>258</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>校验</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>****</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>4</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>结束字</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>03</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr></tbody></table><div>sak = 0x08             为M1卡其它为CPU卡</div><div>selete_aid = 0x04        标识M1卡</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>    uint8_t status;     //用于存储错误码</div><div>    uint8_t sw[2];        //每次操作后的sw值，用于配合错误码上报错误</div><div>    uint8_t new_time[7];   //在寻卡阶段为k21时间，在消费阶段为消费时间</div><div>    uint8_t atqa[2];     //用于判断uid长度和比特帧防冲突</div><div>    uint8_t uid[4];        //唯一识别符</div><div>    uint8_t sak;        //选择确认</div><div>    uint8_t ats[64];    //RATS返回值</div><div>    uint8_t selete_aid; //总结82字节</div><div>    //块0x4</div><div>    uint8_t city_code[2];                    //城市代码</div><div>    uint8_t industry_code[2];                //行业代码</div><div>    uint8_t issuer_code[4];                    //发行流水号</div><div>    uint8_t authentication[4];                //卡认证码</div><div>    uint8_t enable_type;                    //启用标志</div><div>    uint8_t card_type;                        //卡类型</div><div>    uint8_t cash_pledge[2];                    //押金</div><div>    //块0x5</div><div>    uint8_t release_time[4];                 //发行日期</div><div>    uint8_t valid_time[4];                    //有效日期</div><div>   <strike> uint8_t reserved[4];                    //预留空间</strike></div><div><font color="#E30000">    uint8_t card_type2;                        //子卡类型</font></div><div><font color="#E30000">    uint8_t reserved[3];                    //预留空间</font></div><div>    uint8_t add_money_pos_num[4];            //首次加款pos</div><div>    //块0x6</div><div>    uint8_t add_money_time[4];                //加款时间，年月日时</div><div>    uint8_t original_amount[3];                //原额</div><div>    uint8_t add_money_num[3];                //首次加款值</div><div>    uint8_t amount[3];                        //余额</div><div>    uint8_t operator_num[3];                //操作员编号</div><div>   <font color="#FF0000"> //块0x8</font></div><div>    uint8_t cumulative_premium_value[4];    //累计加款值</div><div>    uint8_t reserved1[12];                    //预留空间</div><div>    <font color="#FF0000">//块0x9</font></div><div>    uint8_t blanace[4];                        //钱包</div><div>    uint8_t blanace_inverse_code[4];        //4字节钱包反码</div><div>    uint8_t blanace_[4];                    //钱包</div><div>    uint8_t verify[4];                        //校验</div><div>   <font color="#FF0000"> //块0xA</font></div><div>    uint8_t blanace_2[4];                    //钱包</div><div>    uint8_t blanace_inverse_code_2[4];        //4字节钱包反码</div><div>    uint8_t blanace__2[4];                    //钱包</div><div>    uint8_t verify_2[4];                    //校验</div><div>    //块0x18                                //消费卡                        //管理卡数据</div><div>    uint8_t load_transaction_number[2];        //钱包圈存交易次数            //预留</div><div>    uint8_t transaction_number[2];            //钱包消费交易次数            //刷卡次数</div><div>    uint8_t transaction_type;                //交易类型                    //交易类型标识</div><div>    uint8_t transaction_money[2];            //交易金额                    //预留</div><div>    uint8_t blacklist_type;                     //黑名单标志                    //黑名单标志</div><div>    uint8_t load_point;                        //圈存记录指针                //预留</div><div>    uint8_t record_pointer;                    //消费记录指针                //刷卡记录指针</div><div>    uint8_t interval_marker;                //区间标志位                    //预留</div><div>    uint8_t reserved2;                        //预留</div><div>    uint8_t verify2[4];                        //校验</div><div>    //块0x19</div><div>    uint8_t load_transaction_number_2[2];    //钱包圈存交易次数            //预留</div><div>    uint8_t transaction_number_2[2];        //钱包消费交易次数            //刷卡次数</div><div>    uint8_t transaction_type_2;                //交易类型                    //交易类型标识</div><div>    uint8_t transaction_money_2[2];            //交易金额                    //预留</div><div>    uint8_t blacklist_type_2;                //黑名单标志                    //黑名单标志</div><div>    uint8_t load_point_2;                    //圈存记录指针                //预留</div><div>    uint8_t record_pointer_2;                //消费记录指针                //刷卡记录指针</div><div>    uint8_t interval_marker_2;                //区间标志位                    //预留</div><div>    uint8_t reserved2_2;                    //预留</div><div>    uint8_t verify2_2[4];                    //校验</div><div>    //块0x2C~2E</div><div>    uint8_t block_11[3][16];                //管理卡控制信息（如下图）</div><div>    //块0x1C~1D//用于多票</div><div>    uint8_t complete_mark;                    //完成标志</div><div>    uint8_t link_number[2];                    //线路编号</div><div>    uint8_t driver_direction;                //行车方向</div><div>    uint8_t boarding_site_index;            //上车站点索引</div><div>    uint8_t full_fare[2];                    //上车时全程票价</div><div>    uint8_t boarding_time[7];                //上车时间</div><div>    uint8_t verify3[2];                        //校验</div><div>    uint8_t vehicle_number[3];                //车辆号</div><div>    uint8_t pose_id[6];                        //psam卡号</div><div>  <strike>  uint8_t reserved3[7];                    //预留</strike></div><div><font color="#FF0000">    uint8_t pre_preferential_amount[2];        //优惠前金额</font></div><div><font color="#FF0000">    uint8_t version;                        //版本号</font></div><div><font color="#FF0000">    uint8_t line_1;                            //线路号1</font></div><div><font color="#FF0000">    uint8_t reserved3[3];                    //预留</font></div></div><div><br/></div><div><br/></div><div><span style="font-size: 14pt;">1.2 M1卡消费</span></div><div>* 下发命令：</div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 474px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>定义</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>数据（16进制）</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>长度(字节)</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令头</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>02</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>设备类型</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>86</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令编码</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>41</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令参数</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令长度</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>0035</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>发送参数结构体</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>如下</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>53</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>校验</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>*****</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>4</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>结束字</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>03</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr></tbody></table><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>    uint8_t selete_aid; </div><div>    uint8_t uid[4];        //唯一识别符    </div><div>    uint8_t blacklist_type;                //黑名单标志</div><div>    uint8_t transaction_type;            //交易类型</div><div>    uint8_t transaction_amount[4];        //交易金额</div><div>    uint8_t mark_update_24;                //判断是否更新24块的数据 00标识更新，01不更新（以下的更新标识都是在确认块数据正确，且正副本覆盖后的条件下判断的）</div><div>    uint8_t mark_update_9;                //判断是否更新9块的数据 00标识更新，01不更新</div><div>    uint8_t transaction_time[7];        //交易日期时间</div><div>    //块0x1C~1D//用于多票</div><div>    uint8_t mark_update_1C;                    //判断是否更新多票 00标识不更新，01更新</div><div>    uint8_t complete_mark;                    //完成标志</div><div>    uint8_t link_number[2];                    //线路编号</div><div>    uint8_t driver_direction;                //行车方向</div><div>    uint8_t boarding_site_index;            //上车站点索引</div><div>    uint8_t full_fare[2];                    //上车时全程票价</div><div>    uint8_t    boarding_time[7];                //上车时间</div><div>    uint8_t verify3[2];                        //校验</div><div>    uint8_t vehicle_number[3];                //车辆号</div><div>    uint8_t pose_id[6];                        //psam卡号</div><div>   <strike> uint8_t reserved3[7];                    //预留</strike></div><div><font color="#E30000">    uint8_t pre_preferential_amount[2];        //优惠前金额</font></div><div><font color="#E30000">    uint8_t version;                        //版本号</font></div><div><font color="#E30000">    uint8_t line_1;                            //线路号1</font></div><div><font color="#E30000">    uint8_t reserved3[3];                    //预留</font></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>完成标志：0完成，1上车标志；</div><div>行车方向：0上行，1下行；</div><div>线路编号：1字节结算中心号，1字节线路号；</div><div>上车时全程票价：记录当前行驶方向上当前站点到终点的票价；</div><div>上车时间：记录上车时的刷卡时间；</div><div>verify3/18E7：保证票价有效性，如果不是18E7则默认为下车状态。</div><div>车载机保存一条上车记录（交易类型：DD）</div></div><div>* 消费返回：</div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 256px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>定义</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>数据（16进制）</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>长度(字节)</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令头</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>02</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>设备类型</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>06</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令编码</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>41</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令参数</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>状态</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令长度</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>006b</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>接收参数结构体</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>如下</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>107</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>校验</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>************</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>4</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>结束字</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>03</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr></tbody></table><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>    uint8_t status;     //用于存储错误码</div><div>    uint8_t sw[2];        //每次操作后的sw值，用于配合错误码上报错误</div><div>    uint8_t block_6[2][16];</div><div>    uint8_t block_2[3][16];</div><div>    uint8_t block_9[16];//交易后块数据</div><div>    uint8_t tac[4] ;//计算出来的tac值</div><div>    //--------------------------------------------------------------------------------------------------卡片信息</div><div>    uint8_t uid[4];                        //唯一标识</div></div><div><br/></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#E30000">说明：</font></div><div>uint8_t block_6[2][16];</div><div>uint8_t block_2[3][16];</div><div>都为消费前数据</div><div><br/></div><div>其中block_6[2][16]<span style="font-family: Monaco; font-size: 9pt;">为：</span></div><div>  //块0x18                                //消费卡                        //管理卡数据</div><div>    uint8_t load_transaction_number[2];        //钱包圈存交易次数            //预留</div><div>    uint8_t transaction_number[2];            //钱包消费交易次数            //刷卡次数</div><div>    uint8_t transaction_type;                //交易类型                    //交易类型标识</div><div>    uint8_t transaction_money[2];            //交易金额                    //预留</div><div>    uint8_t blacklist_type;                     //黑名单标志                    //黑名单标志</div><div>    uint8_t load_point;                        //圈存记录指针                //预留</div><div>    uint8_t record_pointer;                    //消费记录指针                //刷卡记录指针</div><div>    uint8_t interval_marker;                //区间标志位                    //预留</div><div>    uint8_t reserved2;                        //预留</div><div>    uint8_t verify2[4];                        //校验</div><div>    //块0x19</div><div>    uint8_t load_transaction_number_2[2];    //钱包圈存交易次数            //预留</div><div>    uint8_t transaction_number_2[2];        //钱包消费交易次数            //刷卡次数</div><div>    uint8_t transaction_type_2;                //交易类型                    //交易类型标识</div><div>    uint8_t transaction_money_2[2];            //交易金额                    //预留</div><div>    uint8_t blacklist_type_2;                //黑名单标志                    //黑名单标志</div><div>    uint8_t load_point_2;                    //圈存记录指针                //预留</div><div>    uint8_t record_pointer_2;                //消费记录指针                //刷卡记录指针</div><div>    uint8_t interval_marker_2;                //区间标志位                    //预留</div><div>    uint8_t reserved2_2;                    //预留</div><div>    uint8_t verify2_2[4];                    //校验</div><div>其中block2[3][16]为：</div><div>    //块0x8</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">        补充16字节0x00</span></div><div>    //块0x9//消费前金额</div><div>    uint8_t blanace[4];                        //钱包</div><div>    uint8_t blanace_inverse_code[4];        //4字节钱包反码</div><div>    uint8_t blanace_[4];                    //钱包</div><div>    uint8_t verify[4];                        //校验</div><div>    //块0xA</div><div>    uint8_t blanace_2[4];                    //钱包</div><div>    uint8_t blanace_inverse_code_2[4];        //4字节钱包反码</div><div>    uint8_t blanace__2[4];                    //钱包</div><div>    uint8_t verify_2[4];                    //校验</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">其中block_9[16]为：</span></div><div>    //块0x9//消费后金额</div><div>    uint8_t blanace[4];                        //钱包</div><div>    uint8_t blanace_inverse_code[4];        //4字节钱包反码</div><div>    uint8_t blanace_[4];                    //钱包</div><div>    uint8_t verify[4];                        //校验</div></div><div><div><br/></div><hr/><div><span style="font-size: 18pt;">2.本地卡消费</span></div><div><span style="font-size: 16pt;">2.1寻卡返回</span></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>定义</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>数据（16进制）</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>长度(字节)</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令头</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>02</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>设备类型</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>86</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令编码</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>40</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令参数</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>状态</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令长度</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>00C1</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>接收参数结构体</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>如下</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>193</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>校验</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>****</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>4</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>结束字</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>03</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr></tbody></table><div>sak = 0x08             为M1卡其它为CPU卡</div><div>selete_aid = 0x03        标识本地卡</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>    //---------------------------------------------------15文件</div><div>    uint8_t card_issuer[8];                    //发卡机构标识</div><div>    uint8_t version_number;                    //应用版本号</div><div>    uint8_t city_code[2];                    //城市代码</div><div>    uint8_t card_type;                        //卡类型</div><div>    uint8_t pan[10];                          //卡内号</div><div>    uint8_t enabling_time[4];                 //启用日期</div><div>    uint8_t valid_time[4];                    //有效日期</div><div>    uint8_t sign_name;                        //是否记名</div><div>    uint8_t cash_pledge[2];                    //押金</div><div>    uint8_t min_amount[2];                    //最低余额限制</div><div>    uint8_t using_mark;                        //使用标记</div><div>    uint8_t max_amount[4];                    //最高消费金额</div><div>    uint8_t online_account_mark;            //联机账户标记</div><div>    uint8_t taxi_driver_card;                //出租车司机卡标志</div><div>    uint8_t reserve[8];                        //预留</div><div>    //---------------------------------------------------1C文件</div><div>    uint8_t complete_mark;                    //完成标志</div><div>    uint8_t link_number[2];                    //线路编号</div><div>    uint8_t driver_direction;                //行车方向</div><div>    uint8_t boarding_site_index;            //上车站点索引</div><div>    uint8_t full_fare[2];                    //上车时全程票价</div><div>    uint8_t    boarding_time[7];                //上车时间</div><div>    uint8_t vehicle_number[3];                //车辆号</div><div>    uint8_t pose_id[6];                        //psam卡号</div><div>    uint8_t verify3[2];                        //校验//18E7</div><div>  <strike>  uint8_t reserved3[9];                    //预留</strike></div><div><font color="#E30000">    uint8_t pre_preferential_amount[2];        //优惠前金额</font></div><div><font color="#E30000">    uint8_t version;                        //版本号</font></div><div><font color="#E30000">    uint8_t line_1;                            //线路号1</font></div><div><font color="#E30000">    uint8_t reserved3[5];                    //预留</font></div><div>    //--------------------------------------------------18文件</div><div>    uint8_t transaction_number_18[2];    //交易序号</div><div>    uint8_t reserve4[3];                //预留</div><div>    uint8_t transaction_amount[4];        //交易金额</div><div>    uint8_t transaction_type;            //交易类型标识</div><div>    uint8_t pose_id_18[6];                    //终端机编号</div><div>    uint8_t transaction_time[7];        //交易时间</div><div>    //--------------------------------------------------余额</div><div>    uint8_t balance[4];                //余额</div></div><div><br/></div><div><span style="font-size: 14pt;">2.2 卡消费</span></div><div>* 下发命令：</div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 474px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>定义</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>数据（16进制）</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>长度(字节)</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令头</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>02</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>设备类型</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>86</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令编码</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>41</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令参数</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令长度</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>0033</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>发送参数结构体</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>如下</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>51</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>校验</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>*****</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>4</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>结束字</div></td><td style="width: 474px; padding: 8px; border: 1px solid;"><div>03</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr></tbody></table><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>    uint8_t selete_aid;</div><div>    uint8_t uid[4];        //唯一识别符</div><div>    uint8_t transaction_amount[4];        //交易金额</div><div>    uint8_t transaction_time[7];        //交易日期时间</div><div>    ////用于多票</div><div>    uint8_t mark_update_1C;                    //判断是否更新多票 00标识不更新，01更新</div><div>    uint8_t complete_mark;                    //完成标志</div><div>    uint8_t link_number[2];                    //线路编号</div><div>    uint8_t driver_direction;                //行车方向</div><div>    uint8_t boarding_site_index;            //上车站点索引</div><div>    uint8_t full_fare[2];                    //上车时全程票价</div><div>    uint8_t    boarding_time[7];                //上车时间</div><div>    uint8_t vehicle_number[3];                //车辆号</div><div>    uint8_t pose_id[6];                        //psam卡号</div><div>    uint8_t verify3[2];                        //校验</div><div><strike>    uint8_t reserved3[9];                    //预留</strike></div><div><font color="#E30000">    uint8_t pre_preferential_amount[2];        //优惠前金额</font></div><div><font color="#E30000">    uint8_t version;                        //版本号</font></div><div><font color="#E30000">    uint8_t line_1;                            //线路号1</font></div><div><font color="#E30000">    uint8_t reserved3[5];                    //预留</font></div></div><div><br/></div><div><br/></div><div>* 消费返回：</div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 256px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>定义</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>数据（16进制）</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>长度(字节)</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令头</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>02</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>设备类型</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>06</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令编码</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>41</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令参数</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>状态</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>00</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>命令长度</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>0033</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>2</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>接收参数结构体</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>如下</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>51</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>校验</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>************</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>4</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>结束字</div></td><td style="width: 256px; padding: 8px; border: 1px solid;"><div>03</div></td><td style="width: 130px; padding: 8px; border: 1px solid;"><div>1</div></td></tr></tbody></table><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div> uint8_t status;     //用于存储错误码</div><div>    uint8_t sw[2];        //每次操作后的sw值，用于配合错误码上报错误</div><div>    //--------------------------------------------------------------------------------------------------消费初始化</div><div>    uint8_t card_remain[4];                //卡片余额</div><div>    uint8_t transaction_number[2];        //交易序号</div><div>    uint8_t overdrawn_account[3];        //透支限额</div><div>    uint8_t key_version;                //密钥版本号</div><div>    uint8_t key_flag;                    //密钥标识</div><div>    uint8_t random_number[4];            //伪随机数</div><div>    //--------------------------------------------------------------------------------------------------PSAM卡计算的MAC1</div><div>    uint8_t sam_transaction_number[4]; //终端交易序号</div><div>    uint8_t MAC1[4];                   //MAC1</div><div>    //--------------------------------------------------------------------------------------------------验证MAC1，并返回</div><div>    uint8_t TAC[4];                     //交易认证码</div><div>    uint8_t MAC2[4];                   //MAC2</div><div>    //--------------------------------------------------------------------------------------------------PSAM卡验证MAC2，获取余额</div><div>    uint8_t balance[4];                    //余额</div><div>    //--------------------------------------------------------------------------------------------------卡片信息</div><div>    uint8_t uid[4];                        //唯一标识</div><div>    uint8_t card_id[8] ;                   //应用序列号</div><div>    uint8_t card_type;                    //卡类型</div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 